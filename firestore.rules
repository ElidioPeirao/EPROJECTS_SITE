
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Funções de Apoio
    // =================================

    function isAuth() {
      return request.auth != null;
    }

    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function getUserRole(userId) {
      return getUserData(userId).role;
    }
    
    function isAdmin() {
      return isAuth() && getUserRole(request.auth.uid) == 'ADMIN';
    }
    
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function canAccessCourses() {
      let role = getUserRole(request.auth.uid);
      return isAuth() && (role == 'E-MASTER' || role == 'ADMIN');
    }

    // =================================
    // Regras das Coleções
    // =================================

    // Coleção de Usuários (users)
    match /users/{userId} {
      allow create: if isAuth();
      allow read: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin(); // Admin pode banir/deletar
    }

    // Coleção de Ferramentas (tools) e suas categorias
    match /tools/{toolId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    match /toolCategories/{categoryId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // Coleção de Códigos Bônus (bonusCodes)
    match /bonusCodes/{codeId} {
      allow read: if isAdmin(); 
      allow create, delete: if isAdmin();
      allow update: if isAuth(); // Usuário usa o código (diminui usesLeft)
    }

    // Coleção de Orçamentos (budgets)
    match /budgets/{budgetId} {
      allow create: if isAuth();
      allow read, update: if (isAuth() && resource.data.userId == request.auth.uid) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Coleção de Notificações (notifications)
    match /notifications/{notificationId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // Coleção de Cursos (courses)
    match /courses/{courseId} {
      allow read: if canAccessCourses();
      allow write: if isAdmin();
      
      // Subcoleção de Aulas (lessons)
      match /lessons/{lessonId} {
        allow read: if canAccessCourses();
        allow write: if isAdmin();
      }
    }
  }
}
